<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario de Postulación - RN Los Ríos 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        /* Estilos CSS (manteniendo los estilos existentes) */
        :root {
            --primary-color: #1a3a5f;
            --secondary-color: #2c5282;
            --accent-color: #4299e1;
            --light-color: #f7fafc;
            --dark-color: #2d3748;
            --success-color: #38a169;
            --error-color: #e53e3e;
            --border-color: #e2e8f0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo i {
            font-size: 2rem;
            margin-right: 1rem;
            color: white;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
        }
        
        .logo span {
            display: block;
            font-size: 0.9rem;
            font-weight: 400;
            opacity: 0.8;
        }
        
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        h1 {
            font-size: 1.8rem;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
        }
        
        h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        
        h3 {
            font-size: 1.2rem;
            margin-top: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-control, .form-select {
            border-radius: 4px;
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
            outline: none;
        }
        
        .form-select:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background-color: var(--error-color);
        }
        
        .btn-danger:hover {
            background-color: #c53030;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #2f855a;
        }
        
        .btn:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        .dynamic-section {
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            background-color: #f9fafb;
            position: relative;
            transition: box-shadow 0.2s;
        }
        
        .dynamic-section:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .error-message {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }
        
        .required-field::after {
            content: " *";
            color: var(--error-color);
        }
        
        .checkbox-group {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
        }
        
        hr {
            border-top: 1px solid var(--border-color);
            margin: 2.5rem 0;
        }
        
        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 0;
            margin-top: 3rem;
        }
        
        .footer .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .footer-links a {
            color: white;
            margin-left: 1.5rem;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .footer-links a:hover {
            opacity: 1;
        }
        
        .progress-container {
            margin-bottom: 2rem;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .progress {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -0.75rem;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
            padding: 0 0.75rem;
        }
        
        .form-section {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .form-section-title {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .form-section-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-right: 1rem;
        }
        
        .form-section-title h2 {
            margin: 0;
            border: none;
            padding: 0;
        }
        
        .add-button {
            margin-top: 1rem;
        }
        
        .add-button i {
            margin-right: 0.5rem;
        }
        
        .form-hint {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 0.25rem;
        }
        
        .form-control.is-valid {
            border-color: var(--success-color);
        }
        
        .form-control.is-invalid {
            border-color: var(--error-color);
        }
        
        .valid-feedback {
            color: var(--success-color);
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .invalid-feedback {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        
        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .cargo-filters {
            background-color: #f0f4f8;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .cargo-filters .form-group {
            margin-bottom: 0.75rem;
        }
        
        .cargo-filters label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .captcha-container {
            margin: 2rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .form-row {
                flex-direction: column;
            }
            .form-col {
                min-width: 100%;
                padding: 0;
            }
            .footer .container {
                flex-direction: column;
                text-align: center;
            }
            .footer-links {
                margin-top: 1rem;
            }
            .footer-links a {
                margin: 0 0.75rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-landmark"></i>
                <div>
                    <h1>Formulario de Postulación</h1>
                    <span>RN Los Ríos 2025</span>
                </div>
            </div>
            <div class="header-info">
                <i class="fas fa-user-circle fa-2x"></i>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="progress-container">
            <div class="progress-text">
                <span>Progreso del formulario</span>
                <span id="progressPercentage">0%</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <form id="cvForm">
            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-user"></i>
                    <h2>Datos Personales</h2>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="rut" class="required-field">RUT</label>
                            <input type="text" class="form-control" id="rut" name="rut" placeholder="Ej: 12.345.678-9" required>
                            <div class="invalid-feedback" id="rutError">El RUT no es válido</div>
                            <div class="form-hint">Ingrese su RUT sin puntos y con guión</div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="nombres" class="required-field">Nombres</label>
                            <input type="text" class="form-control" id="nombres" name="nombres" required>
                            <div class="valid-feedback">Campo válido</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="apellido_paterno" class="required-field">Apellido Paterno</label>
                            <input type="text" class="form-control" id="apellido_paterno" name="apellido_paterno" required>
                            <div class="valid-feedback">Campo válido</div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="apellido_materno">Apellido Materno</label>
                            <input type="text" class="form-control" id="apellido_materno" name="apellido_materno">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="fecha_nacimiento">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="nacionalidad">Nacionalidad</label>
                            <input type="text" class="form-control" id="nacionalidad" name="nacionalidad" value="Chilena">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="estado_civil">Estado Civil</label>
                            <input type="text" class="form-control" id="estado_civil" name="estado_civil">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sexo" class="required-field">Sexo</label>
                            <select class="form-select" id="sexo" name="id_sexo" required>
                                <option value="">Seleccione sexo</option>
                            </select>
                            <div class="invalid-feedback">Debe seleccionar una opción</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="domicilio">Domicilio</label>
                    <input type="text" class="form-control" id="domicilio" name="domicilio">
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="contacto_email" class="required-field">Correo Electrónico</label>
                            <input type="email" class="form-control" id="contacto_email" name="contacto_email" placeholder="ejemplo@correo.com" required>
                            <div class="invalid-feedback" id="emailError">El correo electrónico no es válido</div>
                            <div class="valid-feedback">Correo válido</div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="contacto_telefono" class="required-field">Teléfono</label>
                            <input type="tel" class="form-control" id="contacto_telefono" name="contacto_telefono" required>
                            <div class="valid-feedback">Campo válido</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="regionSelect">Región</label>
                            <select class="form-select" id="regionSelect" name="codigo_region">
                                <option value="">Seleccione región</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="provinciaSelect">Provincia</label>
                            <select class="form-select" id="provinciaSelect" name="codigo_provincia" disabled>
                                <option value="">Seleccione provincia</option>
                            </select>
                            <div class="form-hint">Primero seleccione una región</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-share-alt"></i>
                    <h2>Redes Sociales / Web</h2>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="facebook">Facebook</label>
                            <input type="text" class="form-control" id="facebook" name="facebook" placeholder="URL de su perfil">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="x_twitter">X / Twitter</label>
                            <input type="text" class="form-control" id="x_twitter" name="x_twitter" placeholder="@usuario">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="text" class="form-control" id="linkedin" name="linkedin" placeholder="URL de su perfil">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="instagram">Instagram</label>
                            <input type="text" class="form-control" id="instagram" name="instagram" placeholder="@usuario">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="tiktok">TikTok</label>
                            <input type="text" class="form-control" id="tiktok" name="tiktok" placeholder="@usuario">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="youtube">YouTube</label>
                            <input type="text" class="form-control" id="youtube" name="youtube" placeholder="URL de su canal">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="website">Sitio Web</label>
                    <input type="text" class="form-control" id="website" name="website" placeholder="https://www.ejemplo.com">
                </div>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-flag"></i>
                    <h2>Partido Político</h2>
                </div>
                
                <div class="form-group">
                    <label for="partidoSelect" class="required-field">Seleccione Partido</label>
                    <select class="form-select" id="partidoSelect" name="id_partido" required>
                        <option value="">Seleccione partido</option>
                    </select>
                    <div class="invalid-feedback">Debe seleccionar un partido</div>
                </div>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-briefcase"></i>
                    <h2>Cargos de Interés</h2>
                </div>
                
                <div id="cargosContainer"></div>
                <button type="button" class="btn add-button" onclick="agregarCargo()">
                    <i class="fas fa-plus-circle"></i> Agregar cargo
                </button>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-graduation-cap"></i>
                    <h2>Formación Académica (máximo 5)</h2>
                </div>
                
                <div id="formacionContainer"></div>
                <button type="button" class="btn add-button" onclick="agregarFormacion()">
                    <i class="fas fa-plus-circle"></i> Agregar formación
                </button>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-user-tie"></i>
                    <h2>Experiencia Laboral (máximo 6)</h2>
                </div>
                
                <div id="experienciaContainer"></div>
                <button type="button" class="btn add-button" onclick="agregarExperiencia()">
                    <i class="fas fa-plus-circle"></i> Agregar experiencia
                </button>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-users"></i>
                    <h2>Referencias (máximo 3)</h2>
                </div>
                
                <div id="referenciasContainer"></div>
                <button type="button" class="btn add-button" onclick="agregarReferencia()">
                    <i class="fas fa-plus-circle"></i> Agregar referencia
                </button>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h2>Declaraciones de Incompatibilidad</h2>
                </div>
                
                <div id="incompatibilidades">
                    <div class="checkbox-group">
                        <input type="checkbox" id="incomp1" name="incompatibilidades" value="Deudas tributarias o previsionales">
                        <label for="incomp1">Deudas tributarias o previsionales</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="incomp2" name="incompatibilidades" value="Parientes en el servicio">
                        <label for="incomp2">Parientes en el servicio</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="incomp3" name="incompatibilidades" value="Contratos con el Estado">
                        <label for="incomp3">Contratos con el Estado</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="incomp4" name="incompatibilidades" value="Cargos políticos incompatibles">
                        <label for="incomp4">Cargos políticos incompatibles</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="incomp5" name="incompatibilidades" value="Condenas por probidad">
                        <label for="incomp5">Condenas por probidad</label>
                    </div>
                </div>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-file-contract"></i>
                    <h2>Declaraciones Legales</h2>
                </div>
                
                <div id="declaracionesLegales">
                    <div class="checkbox-group">
                        <input type="checkbox" id="legal1" name="declaraciones_legales" value="No existe obligación de informar resultados" required>
                        <label for="legal1" class="required-field">No existe obligación de informar resultados</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="legal2" name="declaraciones_legales" value="Cumpliré disposiciones legales" required>
                        <label for="legal2" class="required-field">Cumpliré disposiciones legales</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="legal3" name="declaraciones_legales" value="Uso interno RN Los Ríos" required>
                        <label for="legal3" class="required-field">Uso interno RN Los Ríos</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="legal4" name="declaraciones_legales" value="Deslinde de responsabilidades" required>
                        <label for="legal4" class="required-field">Deslinde de responsabilidades</label>
                    </div>
                    <div class="invalid-feedback" id="declaracionesError">Debe aceptar todas las declaraciones legales para continuar</div>
                </div>
            </div>

            <div class="form-section fade-in">
                <div class="form-section-title">
                    <i class="fas fa-signature"></i>
                    <h2>Cierre de Formulario</h2>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="nombre_firmante" class="required-field">Nombre Firmante</label>
                            <input type="text" class="form-control" id="nombre_firmante" name="nombre_firmante" required>
                            <div class="valid-feedback">Campo válido</div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="rut_firmante" class="required-field">RUT Firmante</label>
                            <input type="text" class="form-control" id="rut_firmante" name="rut_firmante" placeholder="Debe coincidir con el RUT principal" required>
                            <div class="invalid-feedback" id="rutFirmanteError">El RUT del firmante debe coincidir con el RUT principal</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="lugar" class="required-field">Lugar</label>
                    <input type="text" class="form-control" id="lugar" name="lugar" required>
                    <div class="valid-feedback">Campo válido</div>
                </div>
                
                <div class="form-group">
                    <label>Fecha de Firma</label>
                    <input type="text" class="form-control" id="fecha_firma_display" readonly>
                    <input type="hidden" id="fecha_firma" name="fecha_firma">
                </div>
            </div>

            <!-- reCAPTCHA agregado directamente en el formulario -->
            <div class="captcha-container">
                <div class="form-group">
                    <div class="g-recaptcha" data-sitekey="6Lf4RDAsAAAAAIMOFL_equnHw5wmE_28V9BUbmZr"></div>
                    <div class="invalid-feedback" id="captchaError">Por favor, complete el captcha</div>
                </div>
            </div>

            <div class="form-section fade-in">
                <div class="form-group">
                    <button type="submit" class="btn btn-success" id="submitButton">
                        <i class="fas fa-paper-plane"></i> Enviar CV
                    </button>
                </div>
            </div>
        </form>
    </div>

    <footer class="footer">
        <div class="container">
            <div>
                <p>&copy; 2025 RN Los Ríos - Todos los derechos reservados</p>
            </div>
            <div class="footer-links">
                <a href="#">Política de Privacidad</a>
                <a href="#">Términos y Condiciones</a>
                <a href="#">Contacto</a>
            </div>
        </div>
    </footer>

    <script>
        // URL base configurable para facilitar cambios en el futuro
        const BASE_URL = "https://186.67.61.251:8001";

        // Variables globales para almacenar datos dinámicos
        let cargosDisponibles = [];
        let ministeriosDisponibles = [];
        let regionesDisponibles = [];
        let provinciasDisponibles = [];
        let todasLasProvincias = [];
        
        // Variable para controlar el debounce de updateProgressBar
        let progressBarTimeout;

        // ====== FUNCIONES DE UI DINÁMICA ======
        function agregarCargo() {
            const d = document.createElement("div");
            d.className = "dynamic-section fade-in";
            
            // Crear opciones para los select de filtros
            let opcionesMinisterios = '<option value="">Seleccione ministerio/servicio</option>';
            ministeriosDisponibles.forEach(ministerio => {
                opcionesMinisterios += `<option value="${ministerio}">${ministerio}</option>`;
            });
            
            let opcionesRegiones = '<option value="">Seleccione región</option>';
            regionesDisponibles.forEach(region => {
                opcionesRegiones += `<option value="${region.codigo_region}">${region.nombre_region}</option>`;
            });
            
            let opcionesProvincias = '<option value="">Seleccione provincia</option>';
            provinciasDisponibles.forEach(provincia => {
                opcionesProvincias += `<option value="${provincia.codigo_provincia}" data-region="${provincia.codigo_region}">${provincia.nombre_provincia}</option>`;
            });
            
            let opcionesCargos = '<option value="">Seleccione un cargo</option>';
            
            d.innerHTML = `
                <div class="cargo-filters">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label>Ministerio/Servicio</label>
                                <select class="form-select ministerio-filter">
                                    ${opcionesMinisterios}
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label>Región</label>
                                <select class="form-select region-filter">
                                    ${opcionesRegiones}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label>Provincia</label>
                                <select class="form-select provincia-filter">
                                    ${opcionesProvincias}
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label>Cargo</label>
                                <select class="form-select cargo-select" name="id_cargo">
                                    ${opcionesCargos}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>`;
            
            document.getElementById("cargosContainer").appendChild(d);
            
            // Configurar eventos para los filtros
            const ministerioFilter = d.querySelector('.ministerio-filter');
            const regionFilter = d.querySelector('.region-filter');
            const provinciaFilter = d.querySelector('.provincia-filter');
            const cargoSelect = d.querySelector('.cargo-select');
            
            // Evento para el filtro de ministerio
            ministerioFilter.addEventListener('change', function() {
                filtrarCargos(d);
            });
            
            // Evento para el filtro de región
            regionFilter.addEventListener('change', function() {
                const codigoRegion = this.value;
                
                // Filtrar provincias según la región seleccionada
                const provinciasFiltradas = codigoRegion 
                    ? provinciasDisponibles.filter(p => p.codigo_region === codigoRegion)
                    : provinciasDisponibles;
                
                // Actualizar opciones del select de provincias
                provinciaFilter.innerHTML = '<option value="">Seleccione provincia</option>';
                provinciasFiltradas.forEach(provincia => {
                    const opt = document.createElement("option");
                    opt.value = provincia.codigo_provincia;
                    opt.textContent = provincia.nombre_provincia;
                    provinciaFilter.appendChild(opt);
                });
                
                filtrarCargos(d);
            });
            
            // Evento para el filtro de provincia
            provinciaFilter.addEventListener('change', function() {
                filtrarCargos(d);
            });
            
            updateProgressBar();
        }

        function filtrarCargos(cargoSection) {
            const ministerioFilter = cargoSection.querySelector('.ministerio-filter');
            const regionFilter = cargoSection.querySelector('.region-filter');
            const provinciaFilter = cargoSection.querySelector('.provincia-filter');
            const cargoSelect = cargoSection.querySelector('.cargo-select');
            
            const ministerioSeleccionado = ministerioFilter.value;
            const regionSeleccionada = regionFilter.value;
            const provinciaSeleccionada = provinciaFilter.value;
            
            // Filtrar cargos según los filtros seleccionados
            let cargosFiltrados = cargosDisponibles;
            
            if (ministerioSeleccionado) {
                cargosFiltrados = cargosFiltrados.filter(cargo => cargo.ministerio_servicio === ministerioSeleccionado);
            }
            
            if (regionSeleccionada) {
                cargosFiltrados = cargosFiltrados.filter(cargo => cargo.codigo_region === regionSeleccionada);
            }
            
            if (provinciaSeleccionada) {
                cargosFiltrados = cargosFiltrados.filter(cargo => cargo.codigo_provincia === provinciaSeleccionada);
            }
            
            // Actualizar opciones del select de cargos
            cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
            cargosFiltrados.forEach(cargo => {
                const opt = document.createElement("option");
                opt.value = cargo.id_cargo;
                opt.textContent = cargo.nombre_cargo;
                cargoSelect.appendChild(opt);
            });
        }

        function agregarFormacion() {
            if (document.getElementById("formacionContainer").children.length >= 5) {
                mostrarError("Ha alcanzado el límite máximo de 5 formaciones académicas.");
                return;
            }
            
            const d = document.createElement("div");
            d.className = "dynamic-section fade-in";
            d.innerHTML = `
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Título/Grado</label>
                            <input type="text" class="form-control" name="titulo_grado" placeholder="Título/Grado">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Institución</label>
                            <input type="text" class="form-control" name="institucion" placeholder="Institución">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Año Egreso</label>
                            <input type="number" class="form-control" name="anio_egreso" placeholder="Año egreso" min="1950" max="2030">
                            <div class="invalid-feedback">El año de egreso debe ser un número válido</div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Campo de Estudio</label>
                            <input type="text" class="form-control" name="campo_estudio" placeholder="Campo de estudio">
                        </div>
                    </div>
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>`;
            
            // Agregar validación para el año de egreso
            const yearInput = d.querySelector('input[type="number"]');
            yearInput.addEventListener('blur', function() {
                const year = parseInt(this.value);
                const currentYear = new Date().getFullYear();
                
                if (isNaN(year) || year < 1950 || year > currentYear + 10) {
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    this.nextElementSibling.style.display = 'none';
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
                updateProgressBar();
            });
            
            document.getElementById("formacionContainer").appendChild(d);
            updateProgressBar();
        }

        function agregarExperiencia() {
            if (document.getElementById("experienciaContainer").children.length >= 6) {
                mostrarError("Ha alcanzado el límite máximo de 6 experiencias laborales.");
                return;
            }
            
            const d = document.createElement("div");
            d.className = "dynamic-section fade-in";
            d.innerHTML = `
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Cargo</label>
                            <input type="text" class="form-control" name="cargo" placeholder="Cargo">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Institución</label>
                            <input type="text" class="form-control" name="institucion" placeholder="Institución">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Fecha Desde</label>
                            <input type="date" class="form-control" name="fecha_desde" placeholder="Fecha desde">
                            <div class="invalid-feedback">Debe ingresar una fecha válida</div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Fecha Hasta</label>
                            <input type="date" class="form-control" name="fecha_hasta" placeholder="Fecha hasta">
                            <div class="invalid-feedback">La fecha hasta debe ser posterior a la fecha desde</div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Duración</label>
                            <input type="text" class="form-control" name="duracion_texto" placeholder="Duración (texto)">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Logros</label>
                            <textarea class="form-control" name="logros" placeholder="Logros" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>`;
            
            // Agregar validación para las fechas
            const fechaDesde = d.querySelector('input[name="fecha_desde"]');
            const fechaHasta = d.querySelector('input[name="fecha_hasta"]');
            
            fechaDesde.addEventListener('blur', function() {
                if (!this.value) {
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    this.nextElementSibling.style.display = 'none';
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    
                    // Validar que fecha hasta sea posterior a fecha desde
                    if (fechaHasta.value && new Date(fechaHasta.value) < new Date(this.value)) {
                        fechaHasta.nextElementSibling.style.display = 'block';
                        fechaHasta.classList.add('is-invalid');
                        fechaHasta.classList.remove('is-valid');
                    } else {
                        fechaHasta.nextElementSibling.style.display = 'none';
                        fechaHasta.classList.remove('is-invalid');
                        if (fechaHasta.value) {
                            fechaHasta.classList.add('is-valid');
                        }
                    }
                }
                updateProgressBar();
            });
            
            fechaHasta.addEventListener('blur', function() {
                if (!this.value) {
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else if (fechaDesde.value && new Date(this.value) < new Date(fechaDesde.value)) {
                    this.nextElementSibling.textContent = 'La fecha hasta debe ser posterior a la fecha desde';
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    this.nextElementSibling.style.display = 'none';
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
                updateProgressBar();
            });
            
            document.getElementById("experienciaContainer").appendChild(d);
            updateProgressBar();
        }

        function agregarReferencia() {
            if (document.getElementById("referenciasContainer").children.length >= 3) {
                mostrarError("Ha alcanzado el límite máximo de 3 referencias.");
                return;
            }
            
            const d = document.createElement("div");
            d.className = "dynamic-section fade-in";
            d.innerHTML = `
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Nombre de la Referencia</label>
                            <input type="text" class="form-control" name="nombre_ref" placeholder="Nombre completo">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Contacto</label>
                            <input type="text" class="form-control" name="contacto_ref" placeholder="Teléfono o correo electrónico">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Relación</label>
                    <input type="text" class="form-control" name="relacion_ref" placeholder="Ej: Jefe directo, Colega, etc.">
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>`;
            
            document.getElementById("referenciasContainer").appendChild(d);
            updateProgressBar();
        }

        // ====== FUNCIONES DE UTILIDAD Y CARGA DE DATOS ======
        function validarRut(rut) {
            rut = rut.replace(/\./g, '').replace(/-/g, '');
            const dv = rut.slice(-1).toUpperCase();
            const rutNumerico = rut.slice(0, -1);
            if (rutNumerico.length < 7 || rutNumerico.length > 8) return false;
            let suma = 0;
            let multiplicador = 2;
            for (let i = rutNumerico.length - 1; i >= 0; i--) {
                suma += parseInt(rutNumerico.charAt(i)) * multiplicador;
                multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
            }
            const dvEsperado = 11 - (suma % 11);
            const dvCalculado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();
            return dv === dvCalculado;
        }

        function formatearRut(rut) {
            rut = rut.replace(/\./g, '').replace(/-/g, '');
            const dv = rut.slice(-1);
            const rutNumerico = rut.slice(0, -1);
            let formateado = '';
            let j = 0;
            for (let i = rutNumerico.length - 1; i >= 0; i--) {
                formateado = rutNumerico.charAt(i) + formateado;
                j++;
                if (j === 3 && i > 0) {
                    formateado = '.' + formateado;
                    j = 0;
                }
            }
            return formateado + '-' + dv;
        }

        function normalizarRut(rut) {
            // Eliminar puntos y guiones, y convertir a mayúsculas el dígito verificador
            return rut.replace(/\./g, '').replace(/-/g, '').toUpperCase();
        }

        function updateProgressBar() {
            // Usar debounce para evitar llamadas excesivas
            clearTimeout(progressBarTimeout);
            progressBarTimeout = setTimeout(() => {
                const form = document.getElementById('cvForm');
                const inputs = form.querySelectorAll('input[required], select[required]');
                let filled = 0;
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        if (input.checked) filled++;
                    } else if (input.value.trim() !== '') {
                        filled++;
                    }
                });
                const percentage = Math.round((filled / inputs.length) * 100);
                document.getElementById('progressBar').style.width = percentage + '%';
                document.getElementById('progressPercentage').textContent = percentage + '%';
            }, 100);
        }

        function establecerFechaActual() {
            const fechaActual = new Date();
            const anio = fechaActual.getFullYear();
            const mes = String(fechaActual.getMonth() + 1).padStart(2, '0');
            const dia = String(fechaActual.getDate()).padStart(2, '0');
            const fechaFormateada = `${anio}-${mes}-${dia}`;
            document.getElementById('fecha_firma').value = fechaFormateada;
            document.getElementById('fecha_firma_display').value = `${dia}/${mes}/${anio}`;
        }

        function mostrarError(mensaje) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mensaje}`;
            const container = document.querySelector('.container');
            container.prepend(errorDiv);
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => errorDiv.remove(), 8000);
        }

        function mostrarExito(mensaje) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${mensaje}`;
            const container = document.querySelector('.container');
            container.prepend(successDiv);
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => successDiv.remove(), 8000);
        }

        function cargarDatosReferencia() {
            // Cargar partidos políticos
            fetch(`${BASE_URL}/partidos_public`, { method: "GET" })
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById("partidoSelect");
                    data.forEach(p => {
                        const opt = document.createElement("option");
                        opt.value = p.id_partido;
                        opt.textContent = p.nombre_partido;
                        select.appendChild(opt);
                    });
                })
                .catch(error => {
                    console.error("Error al cargar partidos:", error);
                    mostrarError("Error al cargar los partidos. Por favor, recargue la página.");
                });

            // Cargar opciones de sexo
            fetch(`${BASE_URL}/sexo_public`, { method: "GET" })
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById("sexo");
                    data.forEach(s => {
                        const opt = document.createElement("option");
                        opt.value = s.id_sexo;
                        opt.textContent = s.detalle;
                        select.appendChild(opt);
                    });
                })
                .catch(error => {
                    console.error("Error al cargar opciones de sexo:", error);
                    mostrarError("Error al cargar las opciones de sexo. Por favor, recargue la página.");
                });

            // Cargar todas las provincias al inicio
            fetch(`${BASE_URL}/provincia_public`, { method: "GET" })
                .then(r => r.json())
                .then(data => {
                    todasLasProvincias = data;
                })
                .catch(error => {
                    console.error("Error al cargar todas las provincias:", error);
                });

            // Cargar regiones y configurar evento change
            fetch(`${BASE_URL}/region_public`, { method: "GET" })
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById("regionSelect");
                    data.forEach(r => {
                        const opt = document.createElement("option");
                        opt.value = r.codigo_region;
                        opt.textContent = r.nombre_region;
                        select.appendChild(opt);
                    });
                    
                    select.addEventListener('change', function() {
                        const codigoRegion = this.value;
                        const provinciaSelect = document.getElementById("provinciaSelect");
                        
                        if (codigoRegion) {
                            provinciaSelect.disabled = false;
                            provinciaSelect.nextElementSibling.textContent = "Seleccione una provincia de la lista";
                            
                            // Filtrar provincias localmente
                            const provinciasFiltradas = todasLasProvincias.filter(
                                p => p.codigo_region === codigoRegion
                            );
                            
                            provinciaSelect.innerHTML = '<option value="">Seleccione provincia</option>';
                            provinciasFiltradas.forEach(p => {
                                const opt = document.createElement("option");
                                opt.value = p.codigo_provincia;
                                opt.textContent = p.nombre_provincia;
                                provinciaSelect.appendChild(opt);
                            });
                        } else {
                            provinciaSelect.disabled = true;
                            provinciaSelect.innerHTML = '<option value="">Seleccione provincia</option>';
                            provinciaSelect.nextElementSibling.textContent = "Primero seleccione una región";
                        }
                    });
                })
                .catch(error => {
                    console.error("Error al cargar regiones:", error);
                    mostrarError("Error al cargar las regiones. Por favor, recargue la página.");
                });
        }

        function cargarCargosDisponibles() {
            fetch(`${BASE_URL}/cargos`, { method: "GET" })
                .then(r => r.json())
                .then(data => {
                    cargosDisponibles = data;
                    const ministeriosMap = new Map();
                    data.forEach(cargo => {
                        if (cargo.ministerio_servicio && !ministeriosMap.has(cargo.ministerio_servicio)) {
                            ministeriosMap.set(cargo.ministerio_servicio, cargo.ministerio_servicio);
                        }
                    });
                    ministeriosDisponibles = Array.from(ministeriosMap.values());
                    
                    const regionesMap = new Map();
                    data.forEach(cargo => {
                        if (cargo.codigo_region && !regionesMap.has(cargo.codigo_region)) {
                            regionesMap.set(cargo.codigo_region, {
                                codigo_region: cargo.codigo_region,
                                nombre_region: cargo.nombre_region
                            });
                        }
                    });
                    regionesDisponibles = Array.from(regionesMap.values());
                    
                    const provinciasMap = new Map();
                    data.forEach(cargo => {
                        if (cargo.codigo_provincia && !provinciasMap.has(cargo.codigo_provincia)) {
                            provinciasMap.set(cargo.codigo_provincia, {
                                codigo_provincia: cargo.codigo_provincia,
                                nombre_provincia: cargo.nombre_provincia,
                                codigo_region: cargo.codigo_region
                            });
                        }
                    });
                    provinciasDisponibles = Array.from(provinciasMap.values());
                })
                .catch(error => {
                    console.error("Error al cargar cargos:", error);
                    mostrarError("Error al cargar los cargos disponibles. Por favor, recargue la página.");
                });
        }

        // ====== INICIALIZACIÓN PRINCIPAL ======
        window.onload = function() {
            establecerFechaActual();
            cargarDatosReferencia();
            cargarCargosDisponibles();
            
            // --- Event Listeners de Validación ---
            document.getElementById('rut').addEventListener('blur', function() {
                const rut = this.value;
                if (rut && !validarRut(rut)) {
                    document.getElementById('rutError').style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    document.getElementById('rutError').style.display = 'none';
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    if (rut) this.value = formatearRut(rut);
                }
                updateProgressBar();
            });
            
            document.getElementById('rut_firmante').addEventListener('blur', function() {
                const rutPrincipal = document.getElementById('rut').value;
                const rutFirmante = this.value;
                
                if (rutFirmante && !validarRut(rutFirmante)) {
                    document.getElementById('rutFirmanteError').textContent = 'El RUT del firmante no es válido';
                    document.getElementById('rutFirmanteError').style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else if (rutFirmante && rutPrincipal && normalizarRut(rutFirmante) !== normalizarRut(rutPrincipal)) {
                    document.getElementById('rutFirmanteError').textContent = 'El RUT del firmante debe coincidir con el RUT principal';
                    document.getElementById('rutFirmanteError').style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    document.getElementById('rutFirmanteError').style.display = 'none';
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    if (rutFirmante) this.value = formatearRut(rutFirmante);
                }
                updateProgressBar();
            });
            
            document.getElementById('contacto_email').addEventListener('blur', function() {
                const email = this.value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (email && !emailRegex.test(email)) {
                    document.getElementById('emailError').style.display = 'block';
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    document.getElementById('emailError').style.display = 'none';
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
                updateProgressBar();
            });

            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', updateProgressBar);
            });
            updateProgressBar();
            
            // --- Event Listener de Envío de Formulario ---
            document.getElementById('cvForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validar reCAPTCHA
                if (!grecaptcha.getResponse()) {
                    document.getElementById('captchaError').style.display = 'block';
                    return;
                } else {
                    document.getElementById('captchaError').style.display = 'none';
                }
                
                // Validar formulario
                const form = document.getElementById('cvForm');
                let errores = [];
                
                // Limpiar errores anteriores
                form.querySelectorAll('.is-invalid').forEach(el => {
                    el.classList.remove('is-invalid');
                });
                form.querySelectorAll('.invalid-feedback').forEach(el => {
                    el.style.display = 'none';
                });
                
                // Validar campos requeridos
                const inputs = form.querySelectorAll('input[required], select[required]');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' && !input.checked) {
                        errores.push(`Debe marcar: ${input.labels[0]?.textContent || 'campo requerido'}`);
                        input.classList.add('is-invalid');
                    } else if (input.type !== 'checkbox' && !input.value.trim()) {
                        errores.push(`Complete el campo: ${input.labels[0]?.textContent || input.name}`);
                        input.classList.add('is-invalid');
                    }
                });
                
                // Validar declaraciones legales específicamente
                const declaracionesLegales = document.querySelectorAll("#declaracionesLegales input[type='checkbox'][required]");
                let todasMarcadas = true;
                declaracionesLegales.forEach(checkbox => {
                    if (!checkbox.checked) {
                        todasMarcadas = false;
                        checkbox.classList.add('is-invalid');
                    }
                });
                
                if (!todasMarcadas) {
                    document.getElementById('declaracionesError').style.display = 'block';
                    errores.push('Debe aceptar todas las declaraciones legales');
                }
                
                // Validar RUT del firmante
                const rutPrincipal = document.getElementById('rut').value;
                const rutFirmante = document.getElementById('rut_firmante').value;
                if (rutFirmante && rutPrincipal && normalizarRut(rutFirmante) !== normalizarRut(rutPrincipal)) {
                    document.getElementById('rutFirmanteError').textContent = 'El RUT del firmante debe coincidir con el RUT principal';
                    document.getElementById('rutFirmanteError').style.display = 'block';
                    document.getElementById('rut_firmante').classList.add('is-invalid');
                    errores.push('El RUT del firmante debe coincidir con el RUT principal');
                }
                
                // Si hay errores, mostrarlos y no enviar el formulario
                if (errores.length > 0) {
                    mostrarError('Por favor complete todos los campos requeridos:\n' + errores.join('\n'));
                    // Scroll al primer error
                    const primerError = form.querySelector('.is-invalid');
                    if (primerError) {
                        primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }
                
                // Deshabilitar botón de envío para evitar envíos múltiples
                const submitButton = document.getElementById('submitButton');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                
                // Preparar datos para enviar
                const formData = new FormData(form);
                const candidato = {};
                const excludedFields = ['nombre_firmante', 'rut_firmante', 'fecha_firma', 'lugar', 'g-recaptcha-response'];

                for (let [key, value] of formData.entries()) {
                    if (!excludedFields.includes(key)) {
                        if (key === 'fecha_nacimiento' && !value) continue;
                        candidato[key] = value;
                    }
                }

                const payload = {
                    candidato: candidato,
                    cargos_interes: [...document.getElementById("cargosContainer").children].map(d => ({
                        id_cargo: d.querySelector('select[name="id_cargo"]').value
                    })),
                    formacion_academica: [...document.getElementById("formacionContainer").children].map(d => ({
                        titulo_grado: d.querySelector('input[name="titulo_grado"]').value,
                        institucion: d.querySelector('input[name="institucion"]').value,
                        anio_egreso: d.querySelector('input[name="anio_egreso"]').value,
                        campo_estudio: d.querySelector('input[name="campo_estudio"]').value
                    })),
                    experiencia_laboral: [...document.getElementById("experienciaContainer").children].map(d => ({
                        cargo: d.querySelector('input[name="cargo"]').value,
                        institucion: d.querySelector('input[name="institucion"]').value,
                        fecha_desde: d.querySelector('input[name="fecha_desde"]').value,
                        fecha_hasta: d.querySelector('input[name="fecha_hasta"]').value,
                        duracion_texto: d.querySelector('input[name="duracion_texto"]').value,
                        logros: d.querySelector('textarea[name="logros"]').value
                    })),
                    referencias: [...document.getElementById("referenciasContainer").children].map(d => ({
                        nombre_ref: d.querySelector('input[name="nombre_ref"]').value,
                        contacto_ref: d.querySelector('input[name="contacto_ref"]').value,
                        relacion_ref: d.querySelector('input[name="relacion_ref"]').value
                    })),
                    declaraciones_incompatibilidad: [...document.querySelectorAll("#incompatibilidades input:checked")]
                        .map(c => ({ tipo_incompatibilidad: c.value, respuesta: true })),
                    declaraciones_legales: [...document.querySelectorAll("#declaracionesLegales input")]
                        .map(c => ({ clausula: c.value, aceptado: c.checked })),
                    cierre_formulario: {
                        nombre_firmante: form.nombre_firmante.value,
                        rut_firmante: form.rut_firmante.value,
                        fecha_firma: form.fecha_firma.value,
                        lugar: form.lugar.value
                    }
                };

                try {
                    const res = await fetch(`${BASE_URL}/candidatos-completo`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    const responseData = await res.json();
                    
                    if (responseData.message) {
                        if (responseData.message === "El RUT ya se encuentra registrado") {
                            const rutField = document.getElementById('rut');
                            const rutError = document.getElementById('rutError');
                            rutField.classList.add('is-invalid'); rutField.classList.remove('is-valid');
                            rutError.textContent = responseData.message; rutError.style.display = 'block';
                            rutField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Rehabilitar botón de envío
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar CV';
                        } else {
                            mostrarError(responseData.message);
                            
                            // Rehabilitar botón de envío
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar CV';
                        }
                    } else if (res.ok) {
                        const email = document.getElementById('contacto_email').value;
                        mostrarExito(`¡Formulario enviado con éxito! Pronto recibirá un correo de confirmación en ${email}.`);
                        
                        // Limpiar formulario
                        form.reset();
                        document.getElementById('cargosContainer').innerHTML = '';
                        document.getElementById('formacionContainer').innerHTML = '';
                        document.getElementById('experienciaContainer').innerHTML = '';
                        document.getElementById('referenciasContainer').innerHTML = '';
                        
                        // Rehabilitar botón de envío
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar CV';
                        
                        // Restablecer fecha de firma
                        establecerFechaActual();
                        
                        // Restablecer reCAPTCHA
                        grecaptcha.reset();
                        
                        // Actualizar barra de progreso
                        updateProgressBar();
                    } else {
                        mostrarError(`Error del servidor (${res.status}). Por favor, inténtelo más tarde.`);
                        
                        // Rehabilitar botón de envío
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar CV';
                    }
                } catch (error) {
                    console.error("Error al enviar el formulario:", error);
                    mostrarError("Error de conexión. Por favor, inténtelo nuevamente más tarde.");
                    
                    // Rehabilitar botón de envío
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar CV';
                }
            });
        };
    </script>
</body>
</html>