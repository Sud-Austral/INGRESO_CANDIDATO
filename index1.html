<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario CV RN 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>

<h1>Formulario CV RN 2025</h1>

<form id="cvForm">

<h2>Datos Personales</h2>
<input name="rut" placeholder="RUT" required><br>
<input name="nombres" placeholder="Nombres" required><br>
<input name="apellido_paterno" placeholder="Apellido Paterno" required><br>
<input name="apellido_materno" placeholder="Apellido Materno"><br>
<input type="date" name="fecha_nacimiento"><br>
<input name="nacionalidad" placeholder="Nacionalidad" value="Chilena"><br>
<input name="estado_civil" placeholder="Estado civil"><br>
<input name="sexo" placeholder="Sexo"><br>
<input name="domicilio" placeholder="Domicilio"><br>
<input name="contacto_email" placeholder="Correo electrónico"><br>
<input name="contacto_telefono" placeholder="Teléfono"><br>

<h3>Redes / Web</h3>
<input name="facebook" placeholder="Facebook"><br>
<input name="x_twitter" placeholder="X / Twitter"><br>
<input name="linkedin" placeholder="LinkedIn"><br>
<input name="instagram" placeholder="Instagram"><br>
<input name="tiktok" placeholder="TikTok"><br>
<input name="youtube" placeholder="YouTube"><br>
<input name="website" placeholder="Sitio web"><br>

<h3>Partido Político</h3>
<select name="id_partido" id="partidoSelect" required>
    <option value="">Seleccione partido</option>
</select>

<hr>

<h2>Cargos de Interés</h2>
<div id="cargosContainer"></div>
<button type="button" onclick="agregarCargo()">+ Agregar cargo</button>

<hr>

<h2>Formación Académica (máx 5)</h2>
<div id="formacionContainer"></div>
<button type="button" onclick="agregarFormacion()">+ Agregar formación</button>

<hr>

<h2>Experiencia Laboral (máx 6)</h2>
<div id="experienciaContainer"></div>
<button type="button" onclick="agregarExperiencia()">+ Agregar experiencia</button>

<hr>

<h2>Declaraciones de Incompatibilidad</h2>
<div id="incompatibilidades">
    <label><input type="checkbox" value="Deudas tributarias o previsionales"> Deudas tributarias o previsionales</label><br>
    <label><input type="checkbox" value="Parientes en el servicio"> Parientes en el servicio</label><br>
    <label><input type="checkbox" value="Contratos con el Estado"> Contratos con el Estado</label><br>
    <label><input type="checkbox" value="Cargos políticos incompatibles"> Cargos políticos incompatibles</label><br>
    <label><input type="checkbox" value="Condenas por probidad"> Condenas por probidad</label><br>
</div>

<hr>

<h2>Declaraciones Legales</h2>
<div id="declaracionesLegales">
    <label><input type="checkbox" value="No existe obligación de informar resultados"> No existe obligación de informar resultados</label><br>
    <label><input type="checkbox" value="Cumpliré disposiciones legales"> Cumpliré disposiciones legales</label><br>
    <label><input type="checkbox" value="Uso interno RN Los Ríos"> Uso interno RN Los Ríos</label><br>
    <label><input type="checkbox" value="Deslinde de responsabilidades"> Deslinde de responsabilidades</label><br>
</div>

<hr>

<h2>Cierre de Formulario</h2>
<input name="nombre_firmante" placeholder="Nombre firmante"><br>
<input name="rut_firmante" placeholder="RUT firmante"><br>
<input type="date" name="fecha_firma"><br>
<input name="lugar" placeholder="Lugar"><br>

<hr>

<div class="g-recaptcha" data-sitekey="6Lf4RDAsAAAAAIMOFL_equnHw5wmE_28V9BUbmZr"></div>

<br>
<button type="submit">Enviar CV</button>

</form>

<script>
const BASE_URL = "https://186.67.61.251:8001";

/* ====== PARTIDOS ====== */
fetch(`${BASE_URL}/partidos_public`, { method: "GET" })
    .then(r => r.json())
    .then(data => {
        console.log("partidos",data)
        const select = document.getElementById("partidoSelect");
        data.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id_partido;
            opt.textContent = p.nombre_partido;
            select.appendChild(opt);
        });
    })
    .catch(error => {
        console.error("Error al cargar partidos:", error);
        alert("Error al cargar los partidos. Por favor, recargue la página.");
    });

/* ====== UI DINÁMICA ====== */
function agregarCargo() {
    const d = document.createElement("div");
    d.innerHTML = `
        <input placeholder="Ministerio / Servicio">
        <input placeholder="Cargo específico">
        <button type="button" onclick="this.parentNode.remove()">Eliminar</button><hr>`;
    document.getElementById("cargosContainer").appendChild(d);
}

function agregarFormacion() {
    if (document.getElementById("formacionContainer").children.length >= 5) return alert("Máx 5");
    const d = document.createElement("div");
    d.innerHTML = `
        <input placeholder="Título/Grado">
        <input placeholder="Institución">
        <input placeholder="Año egreso">
        <input placeholder="Campo de estudio">
        <button type="button" onclick="this.parentNode.remove()">Eliminar</button><hr>`;
    document.getElementById("formacionContainer").appendChild(d);
}

function agregarExperiencia() {
    if (document.getElementById("experienciaContainer").children.length >= 6) return alert("Máx 6");
    const d = document.createElement("div");
    d.innerHTML = `
        <input placeholder="Cargo">
        <input placeholder="Institución">
        <input placeholder="Fecha desde">
        <input placeholder="Fecha hasta">
        <input placeholder="Duración (texto)">
        <textarea placeholder="Logros"></textarea>
        <button type="button" onclick="this.parentNode.remove()">Eliminar</button><hr>`;
    document.getElementById("experienciaContainer").appendChild(d);
}

/* ====== SUBMIT ====== */
document.getElementById("cvForm").addEventListener("submit", async e => {
    e.preventDefault();

    if (!grecaptcha.getResponse()) {
        alert("Por favor, complete el captcha");
        return;
    }

    const token = localStorage.getItem("authToken");
    if (!token) {
        alert("Sesión inválida. Por favor, inicie sesión nuevamente.");
        return;
    }

    const f = e.target;
    const formData = new FormData(f);
    const candidato = {};
    
    // Lista de campos que no pertenecen al objeto 'candidato'
    const excludedFields = ['nombre_firmante', 'rut_firmante', 'fecha_firma', 'lugar', 'g-recaptcha-response'];

    // Recopilar datos del candidato, excluyendo campos especiales y fechas vacías
    for (let [key, value] of formData.entries()) {
        if (!excludedFields.includes(key)) {
            // Si el campo es una fecha y está vacío, no lo incluimos en el payload.
            if (key === 'fecha_nacimiento' && !value) {
                continue; // Salta al siguiente campo
            }
            candidato[key] = value;
        }
    }

    const cargosContainer = document.getElementById("cargosContainer");
    const formacionContainer = document.getElementById("formacionContainer");
    const experienciaContainer = document.getElementById("experienciaContainer");

    // Construir el objeto de cierre de formulario, añadiendo solo los campos que tienen valor
    const cierre_formulario = {};
    if (f.nombre_firmante.value) cierre_formulario.nombre_firmante = f.nombre_firmante.value;
    if (f.rut_firmante.value) cierre_formulario.rut_firmante = f.rut_firmante.value;
    // Si la fecha de firma no está vacía, la añadimos
    if (f.fecha_firma.value) cierre_formulario.fecha_firma = f.fecha_firma.value;
    if (f.lugar.value) cierre_formulario.lugar = f.lugar.value;

    const payload = {
        candidato: candidato,
        cargos_interes: [...cargosContainer.children].map(d => ({
            ministerio_servicio: d.children[0].value,
            cargo_especifico: d.children[1].value
        })),
        formacion_academica: [...formacionContainer.children].map(d => ({
            titulo_grado: d.children[0].value,
            institucion: d.children[1].value,
            anio_egreso: d.children[2].value,
            campo_estudio: d.children[3].value
        })),
        experiencia_laboral: [...experienciaContainer.children].map(d => ({
            cargo: d.children[0].value,
            institucion: d.children[1].value,
            fecha_desde: d.children[2].value,
            fecha_hasta: d.children[3].value,
            duracion_texto: d.children[4].value,
            logros: d.children[5].value
        })),
        declaraciones_incompatibilidad: [...document.querySelectorAll("#incompatibilidades input:checked")]
            .map(c => ({ tipo_incompatibilidad: c.value, respuesta: true })),
        declaraciones_legales: [...document.querySelectorAll("#declaracionesLegales input")]
            .map(c => ({ clausula: c.value, aceptado: c.checked })),
        cierre_formulario: cierre_formulario
    };

    console.log("Payload a enviar:", payload);

    try {
        const res = await fetch(`${BASE_URL}/candidatos-completo`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(payload)
        });

        const contentType = res.headers.get("content-type");
        let responseData;
        
        if (contentType && contentType.includes("application/json")) {
            responseData = await res.json();
        } else {
            responseData = await res.text();
            console.error("Respuesta no JSON del servidor:", responseData);
        }
        
        if (res.ok) {
            alert("CV enviado exitosamente");
            // Opcional: limpiar el formulario o redirigir
            // f.reset();
            // window.location.href = "/confirmacion";
        } else {
            if (typeof responseData === 'object' && responseData.message) {
                alert(`Error: ${responseData.message}`);
            } else {
                alert(`Error del servidor (${res.status}): ${typeof responseData === 'string' ? responseData.substring(0, 100) + '...' : 'Error desconocido'}`);
            }
            console.error("Respuesta del servidor:", responseData);
        }
    } catch (error) {
        console.error("Error al enviar el formulario:", error);
        alert("Error de conexión. Por favor, inténtelo nuevamente más tarde.");
    }
});
</script>

</body>
</html>