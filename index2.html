<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario CV RN 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #003366;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-control, .form-select {
            border-radius: 4px;
            border: 1px solid #ddd;
            padding: 8px 12px;
            width: 100%;
        }
        .btn {
            background-color: #003366;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #002244;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .dynamic-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        .required-field::after {
            content: " *";
            color: #dc3545;
        }
        .checkbox-group {
            margin-bottom: 10px;
        }
        hr {
            border-top: 1px solid #ddd;
            margin: 30px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Formulario CV RN 2025</h1>
        
        <form id="cvForm">
            <h2>Datos Personales</h2>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="rut" class="required-field">RUT</label>
                    <input type="text" class="form-control" id="rut" name="rut" placeholder="Ej: 12.345.678-9" required>
                    <div id="rutError" class="error-message">El RUT no es válido</div>
                </div>
                <div class="col-md-6 form-group">
                    <label for="nombres" class="required-field">Nombres</label>
                    <input type="text" class="form-control" id="nombres" name="nombres" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="apellido_paterno" class="required-field">Apellido Paterno</label>
                    <input type="text" class="form-control" id="apellido_paterno" name="apellido_paterno" required>
                </div>
                <div class="col-md-6 form-group">
                    <label for="apellido_materno">Apellido Materno</label>
                    <input type="text" class="form-control" id="apellido_materno" name="apellido_materno">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="fecha_nacimiento">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento">
                </div>
                <div class="col-md-6 form-group">
                    <label for="nacionalidad">Nacionalidad</label>
                    <input type="text" class="form-control" id="nacionalidad" name="nacionalidad" value="Chilena">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="estado_civil">Estado Civil</label>
                    <input type="text" class="form-control" id="estado_civil" name="estado_civil">
                </div>
                <div class="col-md-6 form-group">
                    <label for="sexo">Sexo</label>
                    <input type="text" class="form-control" id="sexo" name="sexo">
                </div>
            </div>
            <div class="form-group">
                <label for="domicilio">Domicilio</label>
                <input type="text" class="form-control" id="domicilio" name="domicilio">
            </div>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="contacto_email" class="required-field">Correo Electrónico</label>
                    <input type="email" class="form-control" id="contacto_email" name="contacto_email" placeholder="ejemplo@correo.com" required>
                    <div id="emailError" class="error-message">El correo electrónico no es válido</div>
                </div>
                <div class="col-md-6 form-group">
                    <label for="contacto_telefono" class="required-field">Teléfono</label>
                    <input type="tel" class="form-control" id="contacto_telefono" name="contacto_telefono" required>
                </div>
            </div>

            <h3>Redes / Web</h3>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="facebook">Facebook</label>
                    <input type="text" class="form-control" id="facebook" name="facebook">
                </div>
                <div class="col-md-6 form-group">
                    <label for="x_twitter">X / Twitter</label>
                    <input type="text" class="form-control" id="x_twitter" name="x_twitter">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="linkedin">LinkedIn</label>
                    <input type="text" class="form-control" id="linkedin" name="linkedin">
                </div>
                <div class="col-md-6 form-group">
                    <label for="instagram">Instagram</label>
                    <input type="text" class="form-control" id="instagram" name="instagram">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="tiktok">TikTok</label>
                    <input type="text" class="form-control" id="tiktok" name="tiktok">
                </div>
                <div class="col-md-6 form-group">
                    <label for="youtube">YouTube</label>
                    <input type="text" class="form-control" id="youtube" name="youtube">
                </div>
            </div>
            <div class="form-group">
                <label for="website">Sitio Web</label>
                <input type="text" class="form-control" id="website" name="website">
            </div>

            <h3>Partido Político</h3>
            <div class="form-group">
                <label for="partidoSelect" class="required-field">Seleccione Partido</label>
                <select class="form-select" id="partidoSelect" name="id_partido" required>
                    <option value="">Seleccione partido</option>
                </select>
            </div>

            <hr>

            <h2>Cargos de Interés</h2>
            <div id="cargosContainer"></div>
            <button type="button" class="btn" onclick="agregarCargo()">+ Agregar cargo</button>

            <hr>

            <h2>Formación Académica (máx 5)</h2>
            <div id="formacionContainer"></div>
            <button type="button" class="btn" onclick="agregarFormacion()">+ Agregar formación</button>

            <hr>

            <h2>Experiencia Laboral (máx 6)</h2>
            <div id="experienciaContainer"></div>
            <button type="button" class="btn" onclick="agregarExperiencia()">+ Agregar experiencia</button>

            <hr>

            <h2>Declaraciones de Incompatibilidad</h2>
            <div id="incompatibilidades">
                <div class="checkbox-group">
                    <input type="checkbox" id="incomp1" name="incompatibilidades" value="Deudas tributarias o previsionales">
                    <label for="incomp1">Deudas tributarias o previsionales</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="incomp2" name="incompatibilidades" value="Parientes en el servicio">
                    <label for="incomp2">Parientes en el servicio</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="incomp3" name="incompatibilidades" value="Contratos con el Estado">
                    <label for="incomp3">Contratos con el Estado</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="incomp4" name="incompatibilidades" value="Cargos políticos incompatibles">
                    <label for="incomp4">Cargos políticos incompatibles</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="incomp5" name="incompatibilidades" value="Condenas por probidad">
                    <label for="incomp5">Condenas por probidad</label>
                </div>
            </div>

            <hr>

            <h2>Declaraciones Legales</h2>
            <div id="declaracionesLegales">
                <div class="checkbox-group">
                    <input type="checkbox" id="legal1" name="declaraciones_legales" value="No existe obligación de informar resultados" required>
                    <label for="legal1" class="required-field">No existe obligación de informar resultados</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="legal2" name="declaraciones_legales" value="Cumpliré disposiciones legales" required>
                    <label for="legal2" class="required-field">Cumpliré disposiciones legales</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="legal3" name="declaraciones_legales" value="Uso interno RN Los Ríos" required>
                    <label for="legal3" class="required-field">Uso interno RN Los Ríos</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="legal4" name="declaraciones_legales" value="Deslinde de responsabilidades" required>
                    <label for="legal4" class="required-field">Deslinde de responsabilidades</label>
                </div>
                <div id="declaracionesError" class="error-message">Debe aceptar todas las declaraciones legales para continuar</div>
            </div>

            <hr>

            <h2>Cierre de Formulario</h2>
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="nombre_firmante" class="required-field">Nombre Firmante</label>
                    <input type="text" class="form-control" id="nombre_firmante" name="nombre_firmante" required>
                </div>
                <div class="col-md-6 form-group">
                    <label for="rut_firmante" class="required-field">RUT Firmante</label>
                    <input type="text" class="form-control" id="rut_firmante" name="rut_firmante" placeholder="Debe coincidir con el RUT principal" required>
                    <div id="rutFirmanteError" class="error-message">El RUT del firmante debe coincidir con el RUT principal</div>
                </div>
            </div>
            <div class="form-group">
                <label for="lugar" class="required-field">Lugar</label>
                <input type="text" class="form-control" id="lugar" name="lugar" required>
            </div>
            <div class="form-group">
                <label>Fecha de Firma</label>
                <input type="text" class="form-control" id="fecha_firma_display" readonly>
                <input type="hidden" id="fecha_firma" name="fecha_firma">
            </div>

            <hr>

            <div class="g-recaptcha" data-sitekey="6Lf4RDAsAAAAAIMOFL_equnHw5wmE_28V9BUbmZr"></div>
            <div id="captchaError" class="error-message">Por favor, complete el captcha</div>

            <br>
            <button type="submit" class="btn">Enviar CV</button>
        </form>
    </div>

    <script>
        const BASE_URL = "https://186.67.61.251:8001";

        // Función para validar RUT chileno
        function validarRut(rut) {
            // Eliminar puntos y guión
            rut = rut.replace(/\./g, '').replace(/-/g, '');
            
            // Extraer dígito verificador
            const dv = rut.slice(-1).toUpperCase();
            const rutNumerico = rut.slice(0, -1);
            
            // Validar que el RUT tenga el formato correcto
            if (rutNumerico.length < 7 || rutNumerico.length > 8) {
                return false;
            }
            
            // Calcular dígito verificador esperado
            let suma = 0;
            let multiplicador = 2;
            
            for (let i = rutNumerico.length - 1; i >= 0; i--) {
                suma += parseInt(rutNumerico.charAt(i)) * multiplicador;
                multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
            }
            
            const dvEsperado = 11 - (suma % 11);
            const dvCalculado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();
            
            return dv === dvCalculado;
        }

        // Función para formatear RUT
        function formatearRut(rut) {
            // Eliminar puntos y guión
            rut = rut.replace(/\./g, '').replace(/-/g, '');
            
            // Extraer dígito verificador
            const dv = rut.slice(-1);
            const rutNumerico = rut.slice(0, -1);
            
            // Formatear con puntos y guión
            let formateado = '';
            let j = 0;
            for (let i = rutNumerico.length - 1; i >= 0; i--) {
                formateado = rutNumerico.charAt(i) + formateado;
                j++;
                if (j === 3 && i > 0) {
                    formateado = '.' + formateado;
                    j = 0;
                }
            }
            
            return formateado + '-' + dv;
        }

        // Establecer fecha actual como fecha de firma
        function establecerFechaActual() {
            const fechaActual = new Date();
            const anio = fechaActual.getFullYear();
            const mes = String(fechaActual.getMonth() + 1).padStart(2, '0');
            const dia = String(fechaActual.getDate()).padStart(2, '0');
            const fechaFormateada = `${anio}-${mes}-${dia}`;
            
            document.getElementById('fecha_firma').value = fechaFormateada;
            document.getElementById('fecha_firma_display').value = `${dia}/${mes}/${anio}`;
        }

        // Llamar a la función cuando se carga la página
        window.onload = function() {
            establecerFechaActual();
            
            // Validar RUT principal
            document.getElementById('rut').addEventListener('blur', function() {
                const rut = this.value;
                if (rut && !validarRut(rut)) {
                    document.getElementById('rutError').style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    document.getElementById('rutError').style.display = 'none';
                    this.classList.remove('is-invalid');
                    if (rut) {
                        this.value = formatearRut(rut);
                    }
                }
            });
            
            // Validar RUT del firmante
            document.getElementById('rut_firmante').addEventListener('blur', function() {
                const rutPrincipal = document.getElementById('rut').value;
                const rutFirmante = this.value;
                
                if (rutFirmante && !validarRut(rutFirmante)) {
                    document.getElementById('rutFirmanteError').textContent = 'El RUT del firmante no es válido';
                    document.getElementById('rutFirmanteError').style.display = 'block';
                    this.classList.add('is-invalid');
                } else if (rutFirmante && rutPrincipal && formatearRut(rutFirmante) !== formatearRut(rutPrincipal)) {
                    document.getElementById('rutFirmanteError').textContent = 'El RUT del firmante debe coincidir con el RUT principal';
                    document.getElementById('rutFirmanteError').style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    document.getElementById('rutFirmanteError').style.display = 'none';
                    this.classList.remove('is-invalid');
                    if (rutFirmante) {
                        this.value = formatearRut(rutFirmante);
                    }
                }
            });
            
            // Validar correo electrónico
            document.getElementById('contacto_email').addEventListener('blur', function() {
                const email = this.value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email && !emailRegex.test(email)) {
                    document.getElementById('emailError').style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    document.getElementById('emailError').style.display = 'none';
                    this.classList.remove('is-invalid');
                }
            });
        };

        /* ====== PARTIDOS ====== */
        fetch(`${BASE_URL}/partidos_public`, { method: "GET" })
            .then(r => r.json())
            .then(data => {
                console.log("partidos",data)
                const select = document.getElementById("partidoSelect");
                data.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.id_partido;
                    opt.textContent = p.nombre_partido;
                    select.appendChild(opt);
                });
            })
            .catch(error => {
                console.error("Error al cargar partidos:", error);
                alert("Error al cargar los partidos. Por favor, recargue la página.");
            });

        /* ====== UI DINÁMICA ====== */
        function agregarCargo() {
            const d = document.createElement("div");
            d.className = "dynamic-section";
            d.innerHTML = `
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Ministerio / Servicio</label>
                        <input type="text" class="form-control" placeholder="Ministerio / Servicio">
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Cargo Específico</label>
                        <input type="text" class="form-control" placeholder="Cargo específico">
                    </div>
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">Eliminar</button>
                </div>`;
            document.getElementById("cargosContainer").appendChild(d);
        }

        function agregarFormacion() {
            if (document.getElementById("formacionContainer").children.length >= 5) return alert("Máx 5");
            const d = document.createElement("div");
            d.className = "dynamic-section";
            d.innerHTML = `
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Título/Grado</label>
                        <input type="text" class="form-control" placeholder="Título/Grado">
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Institución</label>
                        <input type="text" class="form-control" placeholder="Institución">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Año Egreso</label>
                        <input type="number" class="form-control" placeholder="Año egreso" min="1950" max="2030">
                        <div class="error-message">El año de egreso debe ser un número válido</div>
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Campo de Estudio</label>
                        <input type="text" class="form-control" placeholder="Campo de estudio">
                    </div>
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">Eliminar</button>
                </div>`;
            
            // Agregar validación para el año de egreso
            const yearInput = d.querySelector('input[type="number"]');
            yearInput.addEventListener('blur', function() {
                const year = parseInt(this.value);
                const currentYear = new Date().getFullYear();
                
                if (isNaN(year) || year < 1950 || year > currentYear + 10) {
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    this.nextElementSibling.style.display = 'none';
                    this.classList.remove('is-invalid');
                }
            });
            
            document.getElementById("formacionContainer").appendChild(d);
        }

        function agregarExperiencia() {
            if (document.getElementById("experienciaContainer").children.length >= 6) return alert("Máx 6");
            const d = document.createElement("div");
            d.className = "dynamic-section";
            d.innerHTML = `
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Cargo</label>
                        <input type="text" class="form-control" placeholder="Cargo">
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Institución</label>
                        <input type="text" class="form-control" placeholder="Institución">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Fecha Desde</label>
                        <input type="date" class="form-control" placeholder="Fecha desde">
                        <div class="error-message">Debe ingresar una fecha válida</div>
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Fecha Hasta</label>
                        <input type="date" class="form-control" placeholder="Fecha hasta">
                        <div class="error-message">La fecha hasta debe ser posterior a la fecha desde</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>Duración</label>
                        <input type="text" class="form-control" placeholder="Duración (texto)">
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Logros</label>
                        <textarea class="form-control" placeholder="Logros" rows="3"></textarea>
                    </div>
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">Eliminar</button>
                </div>`;
            
            // Agregar validación para las fechas
            const fechaDesde = d.querySelector('input[type="date"]:first-of-type');
            const fechaHasta = d.querySelector('input[type="date"]:last-of-type');
            
            fechaDesde.addEventListener('blur', function() {
                if (!this.value) {
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    this.nextElementSibling.style.display = 'none';
                    this.classList.remove('is-invalid');
                    
                    // Validar que fecha hasta sea posterior a fecha desde
                    if (fechaHasta.value && new Date(fechaHasta.value) < new Date(this.value)) {
                        fechaHasta.nextElementSibling.style.display = 'block';
                        fechaHasta.classList.add('is-invalid');
                    } else {
                        fechaHasta.nextElementSibling.style.display = 'none';
                        fechaHasta.classList.remove('is-invalid');
                    }
                }
            });
            
            fechaHasta.addEventListener('blur', function() {
                if (!this.value) {
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                } else if (fechaDesde.value && new Date(this.value) < new Date(fechaDesde.value)) {
                    this.nextElementSibling.textContent = 'La fecha hasta debe ser posterior a la fecha desde';
                    this.nextElementSibling.style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    this.nextElementSibling.style.display = 'none';
                    this.classList.remove('is-invalid');
                }
            });
            
            document.getElementById("experienciaContainer").appendChild(d);
        }

        /* ====== SUBMIT ====== */
        document.getElementById("cvForm").addEventListener("submit", async e => {
            e.preventDefault();

            // Validar que todos los campos de declaraciones legales estén marcados
            const declaracionesLegales = document.querySelectorAll("#declaracionesLegales input[type='checkbox']");
            let todasMarcadas = true;
            
            declaracionesLegales.forEach(checkbox => {
                if (!checkbox.checked) {
                    todasMarcadas = false;
                }
            });
            
            if (!todasMarcadas) {
                document.getElementById('declaracionesError').style.display = 'block';
                return;
            } else {
                document.getElementById('declaracionesError').style.display = 'none';
            }

            // Validar captcha
            if (!grecaptcha.getResponse()) {
                document.getElementById('captchaError').style.display = 'block';
                return;
            } else {
                document.getElementById('captchaError').style.display = 'none';
            }

            // Validar RUT del firmante coincida con RUT principal
            const rutPrincipal = document.getElementById('rut').value;
            const rutFirmante = document.getElementById('rut_firmante').value;
            
            if (formatearRut(rutFirmante) !== formatearRut(rutPrincipal)) {
                document.getElementById('rutFirmanteError').textContent = 'El RUT del firmante debe coincidir con el RUT principal';
                document.getElementById('rutFirmanteError').style.display = 'block';
                document.getElementById('rut_firmante').classList.add('is-invalid');
                return;
            }

            const token = localStorage.getItem("authToken");
            if (!token) {
                alert("Sesión inválida. Por favor, inicie sesión nuevamente.");
                return;
            }

            const f = e.target;
            const formData = new FormData(f);
            const candidato = {};
            
            // Lista de campos que no pertenecen al objeto 'candidato'
            const excludedFields = ['nombre_firmante', 'rut_firmante', 'fecha_firma', 'lugar', 'g-recaptcha-response'];

            // Recopilar datos del candidato, excluyendo campos especiales y fechas vacías
            for (let [key, value] of formData.entries()) {
                if (!excludedFields.includes(key)) {
                    // Si el campo es una fecha y está vacío, no lo incluimos en el payload.
                    if (key === 'fecha_nacimiento' && !value) {
                        continue; // Salta al siguiente campo
                    }
                    candidato[key] = value;
                }
            }

            const cargosContainer = document.getElementById("cargosContainer");
            const formacionContainer = document.getElementById("formacionContainer");
            const experienciaContainer = document.getElementById("experienciaContainer");

            // Construir el objeto de cierre de formulario, añadiendo solo los campos que tienen valor
            const cierre_formulario = {};
            if (f.nombre_firmante.value) cierre_formulario.nombre_firmante = f.nombre_firmante.value;
            if (f.rut_firmante.value) cierre_formulario.rut_firmante = f.rut_firmante.value;
            // La fecha de firma se establece automáticamente
            if (f.fecha_firma.value) cierre_formulario.fecha_firma = f.fecha_firma.value;
            if (f.lugar.value) cierre_formulario.lugar = f.lugar.value;

            const payload = {
                candidato: candidato,
                cargos_interes: [...cargosContainer.children].map(d => ({
                    ministerio_servicio: d.querySelectorAll('input')[0].value,
                    cargo_especifico: d.querySelectorAll('input')[1].value
                })),
                formacion_academica: [...formacionContainer.children].map(d => ({
                    titulo_grado: d.querySelectorAll('input')[0].value,
                    institucion: d.querySelectorAll('input')[1].value,
                    anio_egreso: d.querySelectorAll('input')[2].value,
                    campo_estudio: d.querySelectorAll('input')[3].value
                })),
                experiencia_laboral: [...experienciaContainer.children].map(d => ({
                    cargo: d.querySelectorAll('input')[0].value,
                    institucion: d.querySelectorAll('input')[1].value,
                    fecha_desde: d.querySelectorAll('input')[2].value,
                    fecha_hasta: d.querySelectorAll('input')[3].value,
                    duracion_texto: d.querySelectorAll('input')[4].value,
                    logros: d.querySelectorAll('textarea')[0].value
                })),
                declaraciones_incompatibilidad: [...document.querySelectorAll("#incompatibilidades input:checked")]
                    .map(c => ({ tipo_incompatibilidad: c.value, respuesta: true })),
                declaraciones_legales: [...document.querySelectorAll("#declaracionesLegales input")]
                    .map(c => ({ clausula: c.value, aceptado: c.checked })),
                cierre_formulario: cierre_formulario
            };

            console.log("Payload a enviar:", payload);

            try {
                const res = await fetch(`${BASE_URL}/candidatos-completo`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(payload)
                });

                const contentType = res.headers.get("content-type");
                let responseData;
                
                if (contentType && contentType.includes("application/json")) {
                    responseData = await res.json();
                } else {
                    responseData = await res.text();
                    console.error("Respuesta no JSON del servidor:", responseData);
                }
                
                if (res.ok) {
                    alert("CV enviado exitosamente");
                    // Opcional: limpiar el formulario o redirigir
                    // f.reset();
                    // window.location.href = "/confirmacion";
                } else {
                    if (typeof responseData === 'object' && responseData.message) {
                        alert(`Error: ${responseData.message}`);
                    } else {
                        alert(`Error del servidor (${res.status}): ${typeof responseData === 'string' ? responseData.substring(0, 100) + '...' : 'Error desconocido'}`);
                    }
                    console.error("Respuesta del servidor:", responseData);
                }
            } catch (error) {
                console.error("Error al enviar el formulario:", error);
                alert("Error de conexión. Por favor, inténtelo nuevamente más tarde.");
            }
        });
    </script>
</body>
</html>